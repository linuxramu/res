<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>QA Test Plan</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
body {
  font-family: Inter, sans-serif;
  background: #f7f8f5;
  margin: 0;
  padding: 24px;
  color: #1f2933;
}

h1 { font-size: 26px; margin-bottom: 20px; }
h2 { font-size: 18px; margin: 24px 0 12px; }

/* Tabs */
.tabs {
  display: flex;
  gap: 24px;
  border-bottom: 1px solid #d6dad2;
  margin-bottom: 20px;
}
.tab {
  padding: 10px 0;
  cursor: pointer;
  font-weight: 600;
  color: #5f6f5a;
  border-bottom: 3px solid transparent;
}
.tab.active {
  border-color: #7a9c72;
  color: #1f2933;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

/* Overall */
.overall {
  margin-bottom: 16px;
  padding: 12px 14px;
  border-radius: 8px;
  font-size: 14px;
}
.overall.highlight {
  background: #eef6ff;
  border: 1px solid #d6e6f5;
}
.overall-title {
  font-weight: 600;
  margin-bottom: 8px;
  color: #1f4f8a;
}
.overall-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
}

/* Accordion */
.feature {
  background: #ffffff;
  border: 1px solid #e1e4dd;
  border-radius: 8px;
  margin-bottom: 10px;
}
.feature-header,
.milestone-header {
  padding: 14px 16px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  background: #f2f4ef;
  border-bottom: 1px solid #e1e4dd;
}
.feature-title {
  font-size: 16px;
  font-weight: 600;
}
.feature-meta {
  font-size: 13px;
  color: #5f6f5a;
  text-align: right;
}
.feature-content {
  display: none;
  padding: 12px 16px 16px;
}

/* Tables */
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #e5e7eb;
  text-align: left;
}
th {
  background: #fafafa;
  font-weight: 600;
}
tbody tr:nth-child(even) { background: #f4f6f2; }

/* Badges */
.badge {
  padding: 3px 10px;
  border-radius: 999px;
  font-size: 12px;
  font-weight: 600;
}
.Automated { background: #e6f4ea; color: #1e4620; }
.ReadytoAutomate { background: #fdecc8; color: #7a4a00; }
.InProgress { background: #ede9fe; color: #4c1d95; }
.CantBeAutomated { background: #fde2e2; color: #7f1d1d; }

/* Chevron */
.chevron {
  font-size: 14px;
  margin-right: 10px;
  color: #6b7b67;
  transition: transform 0.2s ease;
}
.feature.open .chevron { transform: rotate(90deg); }

/* Dashboard */
#dashboard iframe {
  width: 100%;
  height: 80vh;
  border: none;
  border-radius: 8px;
}
</style>
</head>

<body>

<h1>QA Test Plan</h1>

<div class="tabs">
  <div class="tab active" data-tab="testplan">Test Coverage</div>
  <div class="tab" data-tab="milestones">Milestones</div>
  <div class="tab" data-tab="dashboard">Dashboard</div>
</div>

<div id="testplan" class="tab-content active">
  <div id="overall"></div>
  <div id="features"></div>
</div>

<div id="milestones" class="tab-content">
  <div id="milestone-accordion"></div>
</div>

<div id="dashboard" class="tab-content">
  <iframe src="dashboard.html"></iframe>
</div>

<script>
const TESTPLAN_CSV = "../data/testplan.csv";
const MILESTONE_CSV = "../data/milestones.csv";

/* Tabs */
document.querySelectorAll(".tab").forEach(tab => {
  tab.onclick = () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-content").forEach(c => c.classList.remove("active"));
    tab.classList.add("active");
    document.getElementById(tab.dataset.tab).classList.add("active");
  };
});

/* Status helpers */
function cls(status) {
  return (status || "").replace(/\s+/g, "").replace("Can't", "Cant");
}

const STATUS_SHORT = {
  Automated: "Done",
  ReadyToAutomate: "RTA",
  InProgress: "IP",
  CantBeAutomated: "Cant"
};

/* ===== TEST PLAN ===== */
fetch(TESTPLAN_CSV)
.then(r => r.text())
.then(csv => {
  const rows = Papa.parse(csv, {
    header: true,
    delimiter: "|",
    skipEmptyLines: true
  }).data;

  const grouped = {};
  const priorityStats = {};

  rows.forEach(row => {
    const feature = row.Feature || "Other";
    const priority = row.Priority || "Unspecified";

    grouped[feature] = grouped[feature] || [];
    grouped[feature].push(row);

    priorityStats[priority] = priorityStats[priority] || { total: 0, done: 0 };
    priorityStats[priority].total++;
    if (row.Status === "Automated") priorityStats[priority].done++;
  });

  /* Overall */
  const order = ["Critical", "High", "Medium", "Low", "Unspecified"];
  document.getElementById("overall").innerHTML = `
    <div class="overall highlight">
      <div class="overall-title">Overall Automation Progress</div>
      ${order.filter(p => priorityStats[p]).map(p => {
        const s = priorityStats[p];
        const pct = Math.round((s.done / s.total) * 100);
        return `<div class="overall-row"><strong>${p}</strong><span>${s.done}/${s.total} → ${pct}%</span></div>`;
      }).join("")}
    </div>
  `;

  /* Features */
  const container = document.getElementById("features");

  Object.keys(grouped).forEach(feature => {
    const tests = grouped[feature];
    const total = tests.length;

    const counts = {
      Automated: 0,
      ReadyToAutomate: 0,
      InProgress: 0,
      CantBeAutomated: 0
    };

    tests.forEach(t => {
      if (counts[t.Status] !== undefined) counts[t.Status]++;
    });

    const summary = Object.keys(counts)
      .filter(s => counts[s] > 0)
      .map(s => {
        const pct = Math.round((counts[s] / total) * 100);
        return `${STATUS_SHORT[s]} ${pct}% (${counts[s]}/${total})`;
      })
      .join(" | ");

    const box = document.createElement("div");
    box.className = "feature";

    const header = document.createElement("div");
    header.className = "feature-header";
    header.innerHTML = `
      <div class="feature-title"><span class="chevron">▸</span>${feature}</div>
      <div class="feature-meta">${summary}</div>
    `;

    const content = document.createElement("div");
    content.className = "feature-content";
    content.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>TCID</th>
            <th>Description</th>
            <th>Type</th>
            <th>Priority</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody>
          ${tests.map(t => `
            <tr>
              <td>${t.TCID || ""}</td>
              <td>${t["Test Case Description"] || ""}</td>
              <td>${t.Type || "-"}</td>
              <td>${t.Priority || "-"}</td>
              <td><span class="badge ${cls(t.Status)}">${STATUS_SHORT[t.Status] || t.Status}</span></td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    header.onclick = () => {
      const open = content.style.display === "block";
      content.style.display = open ? "none" : "block";
      box.classList.toggle("open", !open);
    };

    box.append(header, content);
    container.appendChild(box);
  });
});

/* ===== MILESTONES ===== */
fetch(MILESTONE_CSV)
.then(r => r.text())
.then(csv => {
  const rows = Papa.parse(csv, {
    header: true,
    delimiter: "|",
    skipEmptyLines: true
  }).data;

  const grouped = {};
  rows.forEach(r => {
    const m = r.Milestone || "Other";
    grouped[m] = grouped[m] || [];
    grouped[m].push(r);
  });

  const container = document.getElementById("milestone-accordion");

  Object.keys(grouped).forEach(milestone => {
    const acts = grouped[milestone];
    const achieved = acts.filter(a => a.Status === "Achieved").length;

    const box = document.createElement("div");
    box.className = "feature";

    const header = document.createElement("div");
    header.className = "milestone-header";
    header.innerHTML = `
      <div class="feature-title"><span class="chevron">▸</span>${milestone}</div>
      <div class="feature-meta">${achieved}/${acts.length} achieved</div>
    `;

    const content = document.createElement("div");
    content.className = "feature-content";
    content.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Activity</th>
            <th>Description</th>
            <th>Status</th>
            <th>Comments</th>
          </tr>
        </thead>
        <tbody>
          ${acts.map(a => `
            <tr>
              <td>${a.Activity || "-"}</td>
              <td>${a.Description || "-"}</td>
              <td>${a.Status || "-"}</td>
              <td>${a.Comments || "-"}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;

    header.onclick = () => {
      const open = content.style.display === "block";
      content.style.display = open ? "none" : "block";
      box.classList.toggle("open", !open);
    };

    box.append(header, content);
    container.appendChild(box);
  });
});
</script>

</body>
</html>
